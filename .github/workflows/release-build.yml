name: release-build

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g. v1.2.3) to build artifacts for. Must already exist.'
        required: true
        type: string
  workflow_call:
    inputs:
      tag_name:
        description: 'Release tag (e.g. v1.2.3) to build artifacts for. Must already exist.'
        required: true
        type: string

jobs:
  build:
    name: Build multi-arch binaries
    runs-on: ubuntu-latest
    steps:
      - name: Determine tag from inputs
        id: validate
        run: |
          RAW_TAG="${{ inputs.tag_name }}"
          if [ -z "$RAW_TAG" ]; then RAW_TAG="${{ github.event.inputs.tag }}"; fi
          if [ -z "$RAW_TAG" ]; then echo 'Tag input is required' >&2; exit 1; fi
          TAG="$RAW_TAG"
          if [[ "$TAG" != v* ]]; then TAG="v$TAG"; fi
          echo "normalized_tag=$TAG" >> $GITHUB_OUTPUT
          echo "Using tag: $TAG"
      - name: Checkout tag
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.validate.outputs.normalized_tag }}
          fetch-depth: 0
      - name: Ensure tag exists
        run: |
          TAG="${{ steps.validate.outputs.normalized_tag }}"
          if ! git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Tag $TAG not found in repository" >&2; exit 1; fi
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.x'
      - name: Extract version
        id: vars
        run: |
          TAG="${{ steps.validate.outputs.normalized_tag }}"
          VERSION=${TAG#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      - name: Build artifacts (linux, darwin, windows)
        run: |
          set -euo pipefail
          VERSION='${{ steps.vars.outputs.version }}'
          LDFLAGS="-s -w -X main.version=$VERSION"
          mkdir -p dist
          build() {
            local goos=$1
            local goarch=$2
            local ext=""
            if [ "$goos" = windows ]; then ext=".exe"; fi
            echo "Building $goos/$goarch"
            GOOS=$goos GOARCH=$goarch CGO_ENABLED=0 go build -ldflags "$LDFLAGS" -o "dist/kustomize-fzf$ext" ./cmd/kustomize-fzf
            local tarname="kustomize-fzf_${VERSION}_${goos}_${goarch}.tar.gz"
            (cd dist && tar -czf "$tarname" kustomize-fzf$ext)
            rm dist/kustomize-fzf$ext
          }
          build linux amd64
          build linux arm64
          build darwin amd64
          build darwin arm64
          build windows amd64
      - name: SHA256 sums
        run: |
            cd dist
            shasum -a 256 *.tar.gz > SHA256SUMS
      - name: Upload assets to existing release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          TAG="${{ steps.validate.outputs.normalized_tag }}"
          api_json=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/$TAG")
          upload_url=$(echo "$api_json" | jq -r .upload_url | sed 's/{?name,label}//')
          if [ -z "$upload_url" ] || [ "$upload_url" = "null" ]; then
            echo "Could not find existing release for $TAG" >&2; exit 1; fi
          echo "Uploading assets to $upload_url"
          # Skip uploading if an asset with same name already exists (idempotent re-run)
          existing=$(echo "$api_json" | jq -r '.assets[].name') || true
          for f in dist/*.tar.gz dist/SHA256SUMS; do
            name=$(basename "$f")
            if echo "$existing" | grep -qx "$name"; then
              echo "Skipping existing asset $name"; continue
            fi
            echo "Uploading $name";
            curl -sS -X POST -H "Authorization: Bearer $GITHUB_TOKEN" \
              -H "Content-Type: application/octet-stream" \
              --data-binary @"$f" "$upload_url?name=$name" >/dev/null;
          done
      - name: Summary
        run: |
          echo "### Release Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "Tag: ${{ steps.validate.outputs.normalized_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "Version: ${{ steps.vars.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "Artifacts built:" >> $GITHUB_STEP_SUMMARY
          ls -1 dist >> $GITHUB_STEP_SUMMARY
